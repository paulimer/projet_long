library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(readr)
library(tidyr)
library(tibble)
library(stringr)
library(janitor)
library(tibble)

visium <- Load10X_Spatial("/home/paulet/data/sc_mousebrain_allen/st_mousebrain",
                          filename = "V1_Mouse_Brain_Sagittal_Anterior_Section_2_filtered_feature_bc_matrix.h5",
                          assay = "spatial",
                          slice = "V1_Mouse_Brain_Sagittal_Anterior_Section_2_image.tif")

# save a tsv file for stereoscope
counts_vis <- visium@assays$spatial@counts
counts_vis_stereo <- t(as.data.frame(counts_vis))
write.table(counts_vis_stereo, "~/data/sc_mousebrain_allen/st_mousebrain/st_stereo_rn.tsv", sep = "\t", dec = ".", col.names = NA)


# Really exploit res
stereo_w <- read_tsv("./stereoscope/results/st_stereo_rn/W.2023-05-08115234.822513.tsv") %>%
  clean_names() %>%
  column_to_rownames("x1")
visium <- AddMetaData(visium, metadata = stereo_w)
sp_plot <- SpatialFeaturePlot(visium, features = colnames(stereo_w))
ggsave("./stereoscope/stereo.png")
